source /usr/share/wireguard/.version
unset ARCH


# An attempt to avoid confustion

echo "Installing WireGuard kernel modules..."
for i in `ls /usr/lib/modules | grep -v 'extramodules'`; do
    if [ -f "/usr/lib/modules/${i}/modules.dep" -a -f "/usr/lib/modules/${i}/modules.order" -a -f "/usr/lib/modules/${i}/modules.builtin" ]; then
        echo -e "\033[36m**\033[0m\tBuilding WireGuard kernel modules for $i ..."
        dkms install wireguard/${WGVER} -k $i > /dev/null
    else
        echo -e "\033[33m**\033[0m\tSkipping incomplete kernel modules tree $i ..."
    fi
done

echo "Loading WireGuard kernel modules..."
modprobe wireguard


if [[ `systemctl list-unit-files | awk '/enable/ {print $1}'` == *"wg-quick"* ]]; then
    systemctl list-unit-files | awk '/enable/ {print $1}' | grep wg-quick | while read SRVNAM; do {
        echo "Starting ${SRVNAM}..."
        systemctl start ${SRVNAM}
    } done
else
    echo "No enabled wg-quick service to start. Skipping..."
fi
